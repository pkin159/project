<!DOCTYPE html>
<html>
<head>
<style>
#info {
    position: absolute;
    top: 0px;
    width: 100%;
    padding: 10px;
    text-align: center;
    color: #ff0000
}
#gui {
    position: absolute;
    top: 40px;
    left: 20px;
    height: 350px;
}
body {
  overflow: hidden;
}
</style>
</head>

<body>
<div id="info">demo page<br/>
<a href = "javascript:playScore();">play</a>

</div>

<script src="js/r70/three.min.js"></script>
<script src="js/OrbitControls.js"></script>
<script src="js/KeyboardState.js"></script>
<script src="js/dat.gui.min.js"></script>
<script>



////////init
var camera, scene, renderer, light, controls, gcontrols;
var clock = new THREE.Clock();
///////geometry
var stick1;
///////animate
var hit;
var startT;
//////play & stop
var play, checkF, check;
var count = 0;


var Stick = function(){
    this.bpm = 0;
    this.intensity = .3;
    this.thetaHit = -.2;
    this.thetaMax = this.intensity;
    this.thetaStandby = .1;
    this.stopS = 0;
    this.S = 0;
    this.check = true;
    this.keyframes = [
        {key: 0, value: this.thetaStandby},
        {key: .3, value: this.thetaMax},
        {key: .5, value: this.thetaHit},
        {key: 1, value: this.thetaStandby}
    ];
    ///////geometry
    this.mesh = THREE.Object3D();
    this.position = new THREE.Vector3();
};

Stick.prototype.NewMesh = function(){
    a = new THREE.Object3D();
    var geometry = new THREE.CylinderGeometry(1.4, 1.4, 70, 32);
    var material = new THREE.MeshPhongMaterial({
        color: 0xffff00
    });
    var cylinder = new THREE.Mesh(geometry, material);

    cylinder.rotation.x = Math.PI / 2;
    cylinder.position.set(0, 0, -40);

    var geometry1 = new THREE.CylinderGeometry(1.4, 0.8, 20, 32);
    var cylinder2 = new THREE.Mesh(geometry1, material);

    cylinder2.rotation.x = Math.PI / 2;
    cylinder2.position.set(0, 0, -85);

    var geometry3 = new THREE.SphereGeometry(1.5, 32, 32);
    var sphere = new THREE.Mesh(geometry3, material);
    sphere.position.set(0, 0, -95);

    a.add(cylinder);
    a.add(cylinder2);
    a.add(sphere);

    this.mesh = a;

};
Stick.prototype.Update = function(elapsed,startT,T){
    this.mesh.position.copy(this.position);
//debugger;
    if(this.check){
        this.S = (elapsed - startT) % T / T;

         var angle = this.Interpolator(this.S);
    }
   
    if((angle > this.thetaStandby && this.S > 0.01) && !this.check){
        this.stopS = this.S;
        this.mesh.rotation.x = angle;
    }else{
        this.mesh.rotation.x = angle;
        this.check = false;
    }
    console.log("S",this.S);
    console.log("elapsed", elapsed);
    console.log("startT", startT);
    console.log("T",T);

};
Stick.prototype.Interpolator = function(S){
    for(var i = 0; i < this.keyframes.length; i++){
        if(S > this.keyframes.key) continue;
        else{
            if(i != 0)--i;
            break;
        }
    }
    return this.keyframes[i].value + (S - this.keyframes[i].key) / (this.keyframes[i + 1].key - this.keyframes[i].key) * (this.keyframes[i + 1].value - this.keyframes[i].value);
};
Stick.prototype.UnLocked = function(){
    this.check = true;
}

init();
animate();

function init() {
    scene = new THREE.Scene();
    renderer = new THREE.WebGLRenderer({
        antialias: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x888888);

    var gridXZ = new THREE.GridHelper(100, 20);
    gridXZ.setColors(new THREE.Color(0xff0000), new THREE.Color(0x000000));
    scene.add(gridXZ);


    stick1 = new Stick();
    stick1.NewMesh();
    scene.add(stick1.mesh);
    stick1.position = new THREE.Vector3 (-20, 50, 95);

    Drum();

    camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
    camera.position.y = 80;
    camera.position.z = 400;
    camera.lookAt(new THREE.Vector3(0, 0, 0));

    controls = new THREE.OrbitControls(camera, renderer.domElement);

    var ambientLight = new THREE.AmbientLight(0x555555);
    scene.add(ambientLight);

    var light = new THREE.PointLight(0xffffff, 1, 0);
    light.position.set(100, 100, 100);
    scene.add(light);

    gcontrols = {
        speed: 10.,
        high: 0.1,
        bpm: 60.,
        NOS: 1.
    };
    var gui = new dat.GUI();
    gui.domElement.id = 'gui';
    gui.add(gcontrols, 'bpm', 60, 240);
    gui.add(gcontrols, 'NOS', 1, 2);
    document.body.appendChild(renderer.domElement);
}


function Drum() {
    var drum = new THREE.Object3D();
    var extrudeSettings = {
        amount: 12,
        steps: 1,
        bevelEnabled: false,
        curveSegments: 64
    };

    var arcShape = new THREE.Shape();
    arcShape.absarc(0, 5, 5, 0, Math.PI * 2, 0, false);

    var holePath = new THREE.Path();
    holePath.absarc(0, 5, 4.8, 0, Math.PI * 2, true);
    arcShape.holes.push(holePath);

    var geometry = new THREE.ExtrudeGeometry(arcShape, extrudeSettings);
    /////////////////////////////////////////////////////////////////////
    material = new THREE.MeshPhongMaterial({
        color: 0xff1234
    });

    mesh = new THREE.Mesh(geometry, material);
    mesh.rotation.x = Math.PI / 2
    mesh.position.set(0, 6, -5);

    var topGeometry = new THREE.CircleGeometry(5, 32);
    var topMaterial = new THREE.MeshPhongMaterial({
        color: 0xffffff
    });
    var topMesh = new THREE.Mesh(topGeometry, topMaterial);

    var buttonMesh = topMesh.clone();

    topMesh.rotation.x = -Math.PI / 2;
    topMesh.position.y = 5.5;

    buttonMesh.rotation.x = Math.PI / 2;
    buttonMesh.position.y = -5.5;


    drum.add(buttonMesh);
    drum.add(topMesh);
    drum.add(mesh);
    drum.scale.set(10, 5, 10);
    scene.add(drum);

}


function animate() {

    var T = 60 / gcontrols.bpm * gcontrols.NOS;


    if(hit){
        var elapsed = clock.getElapsedTime();
        stick1.Update(elapsed,startT,T);

    }
    controls.update();
    requestAnimationFrame(animate);
    render();
}

function render() {

    renderer.setClearColor(0x888888);
    renderer.render(scene, camera);
}

function HitOnce(intensity, T){
    console.log("T", T);
    console.log('ht once now', intensity)
    stick1.UnLocked();
    if(!checkF){
        startT = clock.getElapsedTime();
        hit = !hit;
        checkF = !checkF;
    }
    console.log("hitstate", hit);
}

score = [{
    time: 0,
    intensity: 1,
    T: 1
}, {
    time: 1000,
    intensity: 0.5,
    T:1
}, {
    time: 2000,
    intensity: 0.7,
    T:1
}, ];

///////////////////////////////wrong
function playScore() {
         for (var i = 0; i < score.length; i++) {
         setTimeout (function(ii,t){HitOnce(ii,t);}(score[i].intensity, score[i].T), score[i].time);
         }
         }











</script>
</body>

</html>